<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
  </head>
  <body>
    <!-- file upload -->
    <input type="file" id="imageLoader" name="imageLoader"/>
    <label>Image File:</label><br/>
    <canvas id="canvas" width="640" height="640" style="width: 40%"></canvas>

    <!-- video -->
    <video playsinline autoplay style="width:40%"></video>
    <button>Take snapshot</button>

    <!-- Note the usage of `type=module` here as this is an ES6 module -->
    <script type="module">


const canvas = document.getElementById('canvas');
var imageLoader = document.getElementById('imageLoader');
var ctx = canvas.getContext('2d');
const video = document.querySelector('video');
const button = document.querySelector('button');

import init from './pkg/without_a_bundler.js';

init()
    .then(() => import('./pkg/without_a_bundler.js'))
    .then(wasm => {
        button.onclick = flipVideoFeed;
/*
        button.addEventListener('click', () => {
            wasm.draw(ctx, 640, 640);
        });
*/

        
        imageLoader.addEventListener('change', handleImage, false);


        function processFrame() {
            /* set the canvas to the dimensions of the video feed */
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            /* make the snapshot */
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

            //extra
            let image = new Image();
            image.src = canvas.toDataURL();
            ctx.drawImage(image, 0, 0);

            wasm.draw(ctx, 640, 640);

            if (videoOn === true)
                window.requestAnimationFrame(processFrame);
        };

        var videoOn = false;
        var localStream;
        function flipVideoFeed() {
            if (videoOn === false) {
                navigator.mediaDevices.getUserMedia( {audio: false, video: true })
                    .then((stream) => {video.srcObject = stream; localStream = stream;})
                    .then(window.requestAnimationFrame(processFrame))
                    .catch(error => console.error(error));
                videoOn = true;
            } else {
                localStream.getTracks()[0].stop();
                videoOn = false;
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            }
        }


        function handleImage(e){
            var reader = new FileReader();
            const img = new Image();
            reader.onload = function(event){
                img.src = event.target.result;
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                    wasm.draw(ctx, 640, 640);
                }   
            }   
            reader.readAsDataURL(e.target.files[0]);
        }   


        wasm.draw(ctx, 640, 640);
    })
    .catch(console.error);


        // upload image

    </script>
  </body>
</html>
